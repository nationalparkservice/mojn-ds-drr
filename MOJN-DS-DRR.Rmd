---
params:

  reportNumber: ""                           # Optional. Only include this if publishing in the semi-official Data Release Report Series. Contact Joe if you are.
  reportRefID: 
  packageAbstract: >-
    This report summarizes data quality evaluations of discrete data collected for the Mojave Desert Network Inventory and Monitoring Program (MOJN I&M) Desert Springs (DS) protocol from 2016 to 2021. This protocol is designed to monitor... Data collected include...
  dataPackage1RefID: 
  dataPackage1Title: "MOJN I&M Desert Springs Data Package 2016-2021"               # Should match title in data store.
  dataPackage1Description: "MOJN I&M DS 2016-2021"  
  dataPackage2RefID: 0                              # Data Store reference ID for data set associated with this report. You must have at least one.
  dataPackage2Title: "Dataset 2 FULL TITLE"               # Should match title in data store.
  dataPackage2Description: "SHORT TITLE FOR DATASET 1"  
  dataSource: "database"  # Either "local" or "database". If "local", csv data must be in data/raw folder. If database, must be able to connect to the MOJN DS SQL Server db.
  isAccessible: "no" # Either "yes" for a version that is screen-readable or "no" for a version with interactive table and plot formatting.
  
title: |
    | Mojave Desert Network Desert Springs
    | Data Package 2016-2021          
subtitle: |
  | Data Release Report `r params$reportNumber` 
author:
  - name: "Jennifer Bailard"
    affiliation: |
      | Mojave Desert Network
      | Inventory and Monitoring Program 
      | 101 Katzenbach Drive
      | Boulder City, Nevada
date: "`r format(Sys.time(), '%d %B, %Y')`"
abstract: "`r params$packageAbstract`"
editor_options:
  chunk_output_type: inline
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa.csl
link-citations: yes
output:
  html_document:
    df_print: kable
    fig_caption: true
    dev: svg
    highlight: haddock
    smart: no
    theme: journal
    css: !expr here::here('common', 'journalnps.min.css')
    toc: yes
    toc_float: true
    number_sections: true
    includes:
        before_body:
          - !expr here::here('common', 'header.html')
        after_body: 
          - !expr here::here('common', 'footer.html')
  word_document:
    df_print: kable
    fig_caption: yes
    fig_height: 5
    fig_width: 5
    highlight: haddock
    reference_docx: !expr here::here('common', 'DRR Word Template.docx')
---

```{r setup, include=FALSE}

# This setup code loads both reproducible reporting packages
# (delete those not needed) and packages for the actual project.
# Note that it also generates the start of a BibTex literature cited
# including the citations for R and all used packages

# reproducible reporting packages
RRpackages <- c('markdown',     # links to Sundown rendering library
                'rmarkdown',    # newer rendering via pandoc
                'pander',       # alternative renderer for markdown, plus better tables than just knitr
                'knitr',
                "dataMaid",     # for makeCodebooks
                "R.rsp",        # dynamic generation of scientific reports
                "kimisc",       #
                "papeR",        # stat tables
                "texreg",       # formatting regression results for LaTeX or html
                "rmdHelpers",   # misc from Mark Peterson thisFileName() thisFile_knit()
                'yaml',         # format data into markdown
                'rmdformats',   # templates including automatic ToC, also use_bookdown()
                'htmltools',    #
                "bibtex",
                "RefManageR",   # BibTeX reference manager
                "knitcitations",# For working with file paths
                "here"          # nice HTML widget tables
)

inst <- RRpackages %in% installed.packages()
if (length(RRpackages[!inst]) > 0) {
  install.packages(RRpackages[!inst], dep = TRUE, repos = "https://cloud.r-project.org")
}
lapply(RRpackages, library, character.only = TRUE)

# Now repeat for packages used in the analyses
pkgList <- c("devtools",        # tends to be needed/useful
             "RODBC",           # for connection to a database. 
             "EML",             # for data package creation and validation
             "kableExtra",      # added features for table formatting. 
             "english",         # converts numbers into english. Good for all that English stuff.
             "remotes",         # for install_github()
             "tidyverse",       # useful
             "formatR",
             "magrittr",
             "leaflet",
             "plotly",
             "svglite",
             "scales",
             "reactable",
             "DT")

inst <- pkgList %in% installed.packages()
if (length(pkgList[!inst]) > 0) {
  install.packages(pkgList[!inst], dep = TRUE, 
                   repos = "https://cloud.r-project.org")
}

lapply(pkgList, library, character.only = TRUE, quietly = TRUE)

if (! "EMLassemblyline" %in% installed.packages()) remotes::install_github("EDIorg/EMLassemblyline")
if (! "desertsprings" %in% installed.packages()) remotes::install_github("nationalparkservice/mojn-ds-rpackage")
require("EMLassemblyline")
require("desertsprings")

# create stub of citations for packages
pkgBibTex <- lapply(c("base", pkgList, RRpackages), citation)

# pkgBibTex <- do.call()

knitr::opts_chunk$set(
  root.dir = here::here(),
  echo = FALSE,
  comment = " ",
  dev = "svg",
  fig.path = here::here("figures"),
  tidy.opts = list(width.cutoff = 60),
  tidy = TRUE
)
# if ggplot, update theme to default to centered titles
if ("ggplot2" %in% .packages()) {
  theme_update(plot.title = element_text(hjust = 0.5))
}

conn <- OpenDatabaseConnection()
```

``` {r setup.wait, include = FALSE, eval = FALSE}
# Write YAML parameters to file for consistent reuse across report and data packages
save(params,file=here::here("data", "temp", "reportParameters.RData"))

if (params$dataSource == "database") {
  conn <- tryCatch(OpenDatabaseConnection(),
                   error = {conn <- NA})
} else {
  conn <- NA
} 
raw_data_path <- here::here("data", "raw")


```{r GenerateMetadata, eval = FALSE}
source(here::here("dataPackages", "DataPackageTemplate", "generate-metadata.R"))
```

```{r LoadData, include=FALSE}
# Load datasets for use

if (file.exists(file=here::here("data", "temp", "projectMetadata.RData"))) {
  load(file=here::here("data", "temp", "projectMetadata.RData"))
} else{
  projectMetadata<-list()
}
```

<hr>
# Background & Introduction

## Significance

## Threats and Stressors

## Sample Design

``` {r figure1, echo = FALSE, fig.align = "left", fig.cap = "**Figure 1.** Desert springs monitoring locations. (J. Bailard, NPS)", fig.alt = "Map of ...", eval = FALSE}
knitr::include_graphics(here::here("figures", "DS Map 600DPI.jpg"))
```

## Monitoring Questions

# Methods

## Data Collection and Sample Processing

## Data Processing

## Code Availability

# Data Records

```{r Table1, echo = FALSE, alt.text = "Table with the file name of each CSV published as part of the data package and a brief description of each file. There are XX raw files and an additional XX calculated files.", eval = FALSE}
FileName<-c("Column")
Description<-c("Description")
Table<-data.frame(FileName,Description)

reactable(Table,
          columns = list(FileName = colDef(name = "Filename")),
          pagination = FALSE,
          compact = TRUE, striped = TRUE)

```

# Data Quality Evaluation

The data within the data records listed above have been reviewed by staff in the NPS Inventory and Monitoring Division to ensure accuracy, completeness, and consistency with documented data quality standards, as well as for usability and reproducibility. For additional information on data quality standards for this protocol, refer to *Mojave Desert Network Inventory and Monitoring Desert Springs Protocol: Standard Operating Procedures and Supplementary Materials Version 1.0* (NPS/MOJN/NRRâ€”_________), available here: https://irma.nps.gov/DataStore/Reference/Profile/____________.

## Advice and Caveats
 
-
-
-

`r if(params$isAccessible == "yes") {"## General"} else {"## General {.tabset}"}`

### Not sampled

This table lists springs that were not sampled during a field season or visit when they were intended to be monitored. No spring found indicates that there was no evidence of recent discharge, even periodic. Evidence could include riparian or denser wash vegetation or channelization. No spring found usually leads to a spring being rejected and removed from the sample frame. Inaccessible indicates that there were temporary or permanent barriers to physically reaching a spring. Barriers could include road washouts, unsafe terrain, or private property. Some springs were deemed inaccessible due to unsafe terrain in the office, while other springs were deemed inaccessible upon observation of unsafe terrain in the field. Inaccessible springs are skipped in the GRTS draw order, but they are not rejected or removed from the sample frame.

``` {r notsampled, eval = FALSE, fig.alt = "Table listing springs that were not samped during a field season due."}
notsampled <- qcNotSampled(conn = conn, data.source = "database")

if (params$isAccessible == "yes") {
  knitr::kable(notsampled) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE, position = "left")
} else {
  notsampled %>%
    DT::datatable()
}
```

### Completeness 

This table provides the number and percentage of springs monitored at each park for each field season. Large disruptions to the field season occurred in WY2019 with the 35-day lapse in federal appropriations and in WY2020 and WY2021 with travel restrictions due to the COVID-19 pandemic.

``` {r completeness, warning = FALSE, fig.alt = "Table listing the number and percent of springs monitored at each park for each field season."}
completeness <- qcCompleteness(conn = conn, data.source = "database")

if (params$isAccessible == "yes") {
  knitr::kable(completeness) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE, position = "left")
} else {
  completeness %>%
    DT::datatable()
}
```

### Completeness plot

This stacked bar plot shows the percentage of springs monitored at each park for each field season. Large disruptions to the field season occurred in WY2019 with the 35-day lapse in federal appropriations and in WY2020 and WY2021 with travel restrictions due to the COVID-19 pandemic.

``` {r completeness.plot, warning = FALSE, fig.alt = "Stacked bar plot showing the number of springs monitored at each park for each field season."}
completeness.plot <- qcCompletenessPlot(conn = conn, data.source = "database")

if (params$isAccessible == "yes") {
  completeness.plot
} else {
  ggplotly(completeness.plot)
}
```

### Visit date

This table provides the date (month and day) that each spring was visited during each field season. Springs should be visited at approximately the same time of year during each field season, ideally within a few weeks, in order to minimize seasonal effects on the data.

``` {r vistdate, warning = FALSE, fig.alt = "Table listing the date (month and day) that each spring was visited during each field season."}
visitdate <- qcVisitDate(conn = conn, data.source = "database")

if (params$isAccessible == "yes") {
  knitr::kable(visitdate) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE, position = "left")
} else {
  visitdate %>%
    DT::datatable()
}
```

### Visit date timeline

These timelines show ...

``` {r visitdate.timeline, eval = FALSE}
visitdate.plots <- qcVisitDatePlots(conn = conn, data.source = "database")

if (params$isAccessible == "yes") {
  visitdate.plots
} else {
  ggplotly(visitdate.plots)
}
```

### Spring type discrepancies

This table provides a list of springs that have been categorized differently (e.g., rheocrene vs hillslope) during different  visits. Discrepancies typically occur when a spring is dry, and it is difficult to determine the spring type, or when a spring exhibits multiple spring types along its reach.

``` {r discrepancies}
discrepancies <- qcSpringTypeDiscrepancies(conn = conn, data.source = "database")

if (params$isAccessible == "yes") {
  knitr::kable(discrepancies) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE, position = "left")
} else {
  discrepancies %>%
    DT::datatable()
}
```

### Data processing levels

This table lists site visits that have any data labeled as "Raw" or "Provisional." These data need to be reviewed and moved to "Accepted" status before publication of the dataset.

``` {r dpl.check, echo = FALSE, message = FALSE, warning = FALSE, fig.alt = "Table listing any records with data still labeled as Raw or Provisional."}
dpl.check <- qcDPLCheck(conn, data.source = "database")

if (params$isAccessible == "yes") {
  dpl.check %>%
    rename_with(~ gsub(".DPL", "", .x)) %>%
    knitr::kable() %>%
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE, position = "left")
} else {
  dpl.check %>%
    rename_with(~ gsub(".DPL", "", .x)) %>%
    DT::datatable(options = list(scrollX = TRUE))
}
```
`r if(nrow(dpl.check) == 0){"All records have been accepted."}`
`r if(nrow(dpl.check) > 0){"The above records need to be reviewed and accepted before publication."}`

`r if(params$isAccessible == "yes") {"## Sensor information"} else {"## Sensor information {.tabset}"}`

### Sensor summary

### Sensor recovery heatmap

### Problems with recovered sensors

### Sensors retrieved, download status unknown

### Sensor deployed, recovery status unknown

### Retrieval date same as deployment date

### No sensor deployment data

`r if(params$isAccessible == "yes") {"## Flow condition and water quantity"} else {"## Flow condition and water quantity {.tabset}"}`

### Spring discharge summary

### Spring dry, discharge or springbrook > 0

### Spring not dry, discharge = 0

### Spring not dry, springbrook = 0

### Discharge missing

### Volumetric method data missing

### Volumetric method fills < 5

### Volumetric method median fill seconds < 5

### Continuous > discontinuous

### Continuous flow category summary

### Discontinuous flow category summary

### Flow categories annual plot

### Flow categories three-year plot

### Flow categories annual heatmap

### Flow categories three-year heatmap

### Flow category map

``` {r flowmap, echo = FALSE, message = FALSE, warning = FALSE, fig.alt = "Map of spring flow categories for each field season at each park."}
flow.map <- FlowCategoriesMap(conn, data.source = "database")

flow.map

```

`r if(params$isAccessible == "yes") {"## Water quality"} else {"## Water quality {.tabset}"}`

`r if(params$isAccessible == "yes") {"## Water quality"} else {"## Water quality {.tabset}"}`

`r if(params$isAccessible == "yes") {"## Riparian vegetation"} else {"## Riparian vegetation {.tabset}"}`

`r if(params$isAccessible == "yes") {"## Invasive plants"} else {"## Invasive plants {.tabset}"}`

`r if(params$isAccessible == "yes") {"## Flow modification and disturbance"} else {"## Flow modification and disturbance {.tabset}"}`

`r if(params$isAccessible == "yes") {"## Wildlife evidence"} else {"## Wildlife evidence {.tabset}"}`

# Usage Notes
A MOJN Desert Springs R Package that is designed to work with the datasets in their published format is available on GitHub. This package was used to implement the quality checks that are included in this report and to generate the three calculated datasets that are included in this data package.

# Acknowledgements
The authors would like to acknowledge Geoff Moret, who developed the Desert Springs protocol.

# References

\pagebreak

# Appendix A. Code Listing
```{r Listing, ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```

\pagebreak

# Appendix B. Session and Version Information
```{r session-info, echo=FALSE, cache=FALSE}
sessionInfo()
Sys.time()
```

``` {r close.db}
# if (params$dataSource == "database") {
#    CloseDatabaseConnection(conn)
# }

CloseDatabaseConnection(conn)
```
